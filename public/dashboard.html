<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProWorkflow Team Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.4;
            font-size: 14px;
        }

        /* MAIN CONTAINER - ADJUST FOR SIDEBAR */
        .main-container {
            transition: margin-right 0.3s ease;
            margin-right: 0;
        }

        .main-container.chat-open {
            margin-right: 350px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .header p {
            font-size: 1rem;
        }

        .nav-bar {
            background: white;
            padding: 1rem 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .nav-link {
            color: #667eea;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: background-color 0.2s ease;
            font-weight: 500;
        }

        .nav-link:hover {
            background: #f1f5f9;
        }

        .nav-link.active {
            background: #667eea;
            color: white;
        }

        .controls {
            background: white;
            padding: 1.5rem 2rem;
            margin: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .control-group label {
            font-weight: 600;
            color: #555;
            font-size: 0.8rem;
        }

        select, button {
            padding: 0.6rem 0.8rem;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
            transition: all 0.3s ease;
        }

        select:focus, button:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            min-width: 120px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        /* COMMUNICATION LEGEND */
        .communication-legend {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-left: auto;
            display: flex;
            gap: 1.5rem;
            align-items: center;
            font-size: 0.8rem;
        }

        .legend-title {
            font-weight: 600;
            color: #374151;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .legend-badge {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-badge.active { background: #10b981; }
        .legend-badge.normal { background: #f59e0b; }
        .legend-badge.stale { background: #ef4444; }
        .legend-badge.none { background: #94a3b8; }

        .stats {
            display: flex;
            gap: 1rem;
            margin: 0 1.5rem 1.5rem 1.5rem;
            flex-wrap: wrap;
        }

        .stat-card {
            background: white;
            padding: 1.2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            flex: 1;
            min-width: 180px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .projects-container {
            margin: 0 1.5rem 2rem 1.5rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .projects-header {
            background: #f8fafc;
            padding: 1.2rem 1.5rem;
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .projects-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }

        .projects-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .projects-table th {
            background: #f8fafc;
            padding: 0.8rem 1rem;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #e1e8ed;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.8rem;
        }

        .projects-table th.sortable {
            cursor: pointer;
            user-select: none;
            background: #f1f5f9;
            transition: background-color 0.2s ease;
            border: 1px solid #e1e8ed;
        }

        .projects-table th.sortable:hover {
            background: #e2e8f0;
            color: #4c63d2;
        }

        .sort-indicator {
            margin-left: 8px;
            font-size: 0.9rem;
            opacity: 0.7;
            transition: opacity 0.2s ease;
            font-weight: bold;
        }

        .sort-indicator.active {
            opacity: 1;
            color: #667eea;
            font-weight: bold;
        }

        .projects-table td {
            padding: 0.8rem 1rem;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
            word-wrap: break-word;
            max-width: 200px;
        }

        .projects-table tbody tr:hover {
            background: #f8fafc;
        }

        .project-number {
            font-family: 'Monaco', 'Menlo', monospace;
            background: #f1f5f9;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #475569;
        }

        .project-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease;
            font-size: 0.85rem;
            word-wrap: break-word;
            display: block;
        }

        .project-link:hover {
            color: #4c63d2;
            text-decoration: underline;
        }

        .status-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            display: inline-block;
            min-width: 70px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .status-badge:hover {
            transform: scale(1.05);
        }

        /* PHASE 2: STATUS DROPDOWN STYLES */
        .pwf-status-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            min-width: 200px;
            font-size: 12px;
        }

        .status-dropdown-item {
            padding: 6px 10px;
            cursor: pointer;
            color: white;
            margin: 1px 0;
        }

        .status-dropdown-item:hover {
            opacity: 0.8;
        }

        .status-dropdown-item.current {
            border-left: 3px solid white;
        }

        .communication-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            display: inline-block;
            min-width: 70px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .communication-badge:hover {
            transform: scale(1.05);
        }

        .communication-badge.active {
            background: #10b981;
            color: white;
        }

        .communication-badge.normal {
            background: #f59e0b;
            color: white;
        }

        .communication-badge.stale {
            background: #ef4444;
            color: white;
        }

        .communication-badge.none {
            background: #94a3b8;
            color: white;
        }

        .last-message-info {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.2rem;
        }

        .message-author {
            font-weight: 600;
        }

        .message-author.staff {
            color: #2563eb;
        }

        .message-author.client {
            color: #dc2626;
        }

        .days-badge {
            background: #f1f5f9;
            color: #64748b;
            padding: 0.25rem 0.6rem;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .days-badge.urgent {
            background: #fee2e2;
            color: #dc2626;
        }

        .days-badge.warning {
            background: #fef3c7;
            color: #d97706;
        }

			
			
/* Square expand buttons for both projects and tasks */
.expand-btn {
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
border: none;
    padding: 0;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;   /* Force square */
    height: 28px;  /* Force square */
    min-width: 28px;  /* Prevent shrinking */
    max-width: 28px;  /* Prevent growing */
    flex-shrink: 0;   /* Don't shrink in flex containers */
}
.expand-btn:hover {
    background: #e2e8f0;
    border-color: #cbd5e1;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.expand-arrow {
    width: 0;
    height: 0;
    border-left: 6px solid #c6d0ff;
    border-top: 4px solid transparent;
    border-bottom: 4px solid transparent;
    transition: transform 0.3s ease;
    transform-origin: 30% 50%;
}

.expand-btn.expanded .expand-arrow {
    transform: rotate(90deg);
}

/* Task-specific styling */
.task-expand-btn {
    width: 24px;
    height: 24px;
}

.task-expand-btn .expand-arrow {
    border-left: 5px solid #667eea;
    border-top: 3px solid transparent;
    border-bottom: 3px solid transparent;
}
			
			
			
        .project-expansion {
            display: none;
            background: #fafbfc;
            border-left: 4px solid #667eea;
        }

        .project-expansion.expanded {
            display: block;
        }

        .expansion-content {
            padding: 1.5rem;
        }

        /* MESSAGE TIMELINE STYLES */
        .message-timeline {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .timeline-title {
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        .load-more-messages {
            color: #667eea;
            text-decoration: none;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .load-more-messages:hover {
            text-decoration: underline;
        }

        .message-item {
            display: flex;
            gap: 0.8rem;
            padding: 0.8rem;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.85rem;
        }

        .message-item:last-child {
            border-bottom: none;
        }

        .message-item.thread-reply {
            margin-left: 2rem;
            background: #f8fafc;
            border-left: 2px solid #cbd5e1;
            border-radius: 0 8px 8px 0;
            padding-left: 1rem;
        }

        .message-item.thread-reply::before {
            content: '↳ ';
            color: #9ca3af;
            font-weight: bold;
            margin-right: 0.5rem;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .message-content {
            flex: 1;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
        }

        .message-author-name {
            font-weight: 600;
            font-size: 0.85rem;
        }

        .message-date {
            color: #64748b;
            font-size: 0.75rem;
        }

        .message-text {
            color: #475569;
            line-height: 1.4;
        }

        .message-files {
            margin-top: 0.5rem;
        }

        .message-file {
            display: inline-block;
            background: #e0e7ff;
            color: #3730a3;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            text-decoration: none;
            margin-right: 0.5rem;
            margin-top: 0.3rem;
        }

        .message-file:hover {
            background: #c7d2fe;
        }

        /* TASK TABLE STYLES */
        .tasks-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            margin-top: 1rem;
        }

        .tasks-table th {
            background: #f1f5f9;
            padding: 0.6rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e2e8f0;
            font-size: 0.75rem;
        }

        .tasks-table td {
            padding: 0.6rem;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle;
        }

        .tasks-table tbody tr:hover {
            background: #f8fafc;
        }

        .task-checkbox {
            width: 16px;
            height: 16px;
            border: 2px solid #cbd5e1;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .task-checkbox.completed {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        .task-checkbox.completed::after {
            content: '✓';
            font-size: 10px;
            font-weight: bold;
        }

        .task-title {
            font-weight: 600;
            color: #374151;
            word-wrap: break-word;
            line-height: 1.3;
        }

        .task-title.completed {
            text-decoration: line-through;
            opacity: 0.6;
        }

        /* TASK MESSAGE MODAL STYLES */
        .message-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 90%;
            max-height: 80%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-weight: 600;
            color: #374151;
            font-size: 1.1rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #9ca3af;
            min-width: auto;
            padding: 0.5rem;
        }

        .modal-close:hover {
            color: #374151;
            transform: none;
            box-shadow: none;
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        /* TASK MESSAGE BADGES */
        .task-message-badge {
            background: #3b82f6;
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .task-message-badge:hover {
            transform: scale(1.05);
        }

        .task-message-badge.active {
            background: #10b981;
        }

        .task-message-badge.normal {
            background: #f59e0b;
        }

        .task-message-badge.stale {
            background: #ef4444;
        }

        .task-message-badge.none {
            background: #94a3b8;
            cursor: default;
        }

        .task-message-badge.none:hover {
            transform: none;
        }

			.task-message-badge.none:hover {
            transform: none;
        }

/* Message task context styling */
        .message-task-context {
            background: #f0f9ff;
            color: #0c4a6e;
            padding: 0.5rem 0.8rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            margin: 0.4rem 0;
            border-left: 4px solid #0ea5e9;
            font-style: italic;
        }

        .message-task-context:hover {
            background: #e0f2fe;
        }
			
			/* Root message styling */
        .root-message {
            border-left: 3px solid #e2e8f0;
            margin-bottom: 0.5rem;
        }

        /* Thread reply styling - more subtle indent */
        .thread-reply {
            margin-left: 1.5rem;
            background: #f8fafc;
            border-left: 2px solid #cbd5e1;
            border-radius: 0 8px 8px 0;
            padding-left: 0.8rem;
            margin-top: 0.3rem;
        }
        
			/* RIGHT SIDEBAR CHAT */
        .chat-trigger {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            width: 30px;
            height: 90px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .chat-trigger:hover {
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.4);
        }

        .chat-trigger.chat-open {
            right: 370px;
        }

        .chat-sidebar {
            position: fixed;
            top: 0;
            right: -350px;
            width: 350px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.08);
            transition: right 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .chat-sidebar.open {
            right: 0;
        }

        .chat-sidebar-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chat-sidebar-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin: 0;
        }

        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.2rem;
            min-width: auto;
        }

        .chat-close:hover {
            transform: none;
            box-shadow: none;
            opacity: 0.8;
        }

        .chat-sidebar-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            padding-top: 2rem;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background: #f8fafc;
            border-radius: 12px;
            margin-bottom: 1rem;
            max-height: calc(100vh - 250px);
        }

        .chat-message {
            max-width: 80%;
            padding: 0.8rem 1rem;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .chat-message.user {
            align-self: flex-end;
            background: #667eea;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-message.agent {
            align-self: flex-start;
            background: white;
            color: #374151;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chat-input-container {
            display: flex;
            gap: 0.5rem;
        }

        .chat-input {
            flex: 1;
            padding: 0.8rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
            resize: none;
            min-height: 40px;
            max-height: 100px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .chat-send {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.8rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            min-width: auto;
            transition: background-color 0.2s ease;
        }

        .chat-send:hover {
            background: #5a67d8;
            transform: none;
            box-shadow: none;
        }

        .chat-send:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .typing-indicator {
            align-self: flex-start;
            background: white;
            color: #374151;
            padding: 0.8rem 1rem;
            border-radius: 12px;
            border-bottom-left-radius: 4px;
            font-style: italic;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
            color: #667eea;
            font-size: 1.1rem;
        }

        .loading::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #667eea;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-projects {
            text-align: center;
            padding: 3rem;
            color: #666;
            font-size: 1.1rem;
        }

        .no-messages {
            text-align: center;
            padding: 2rem;
            color: #9ca3af;
            font-style: italic;
        }
			
			
			/* Task expansion styling */
.task-expansion-row {
    background: #f8fafc;
}

.task-expansion-content {
    padding: 0;
}

.task-expansion-inner {
    padding: 1.5rem;
    border-left: 4px solid #667eea;
    background: #f8fafc;
}

.task-message-header {
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e2e8f0;
}

.task-message-header h4 {
    color: #374151;
    font-size: 1rem;
    margin-bottom: 0.25rem;
}

.task-message-header p {
    color: #6b7280;
    font-size: 0.85rem;
    margin: 0;
}

.task-messages-list {
    max-height: 300px;
    overflow-y: auto;
}
			
			
			
    </style>
</head>
	<body>
    <div class="main-container" id="mainContainer">
        <div class="header">
            <h1>ProWorkflow Team Dashboard</h1>
            <p>Track your team's projects and communication</p>
        </div>

        <div class="nav-bar">
            <a href="/" class="nav-link active">Dashboard</a>
            <a href="/assignment-queue" class="nav-link">Assignment Queue</a>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="managerSelect">Filter by Manager</label>
                <select id="managerSelect">
                    <option value="">All managers</option>
                </select>
            </div>

            <div class="control-group">
                <label for="sortSelect">Sort by</label>
                <select id="sortSelect">
                    <option value="idle">Most Idle First</option>
                    <option value="age">Oldest Projects</option>
                    <option value="communication">Communication Stale</option>
                    <option value="manager">Manager Name</option>
                    <option value="number">Project Number</option>
                    <option value="status">Status</option>
                    <option value="title">Project Title</option>
                </select>
            </div>

            <div class="control-group">
                <label>&nbsp;</label>
                <button onclick="loadProjects()">Refresh Data</button>
            </div>

            <!-- COMMUNICATION REFERENCE LEGEND -->
            <div class="communication-legend">
                <div class="legend-title">Communication Health:</div>
                <div class="legend-item">
                    <div class="legend-badge active"></div>
                    <span>Active (≤2 days)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-badge normal"></div>
                    <span>Normal (3-7 days)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-badge stale"></div>
                    <span>Stale (&gt;7 days)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-badge none"></div>
                    <span>No Messages</span>
                </div>
            </div>
        </div>

        <div class="stats" id="stats"></div>

        <div class="projects-container">
            <div class="projects-header">
                <div class="projects-title" id="projectsTitle">Team Projects</div>
            </div>
            
            <div class="projects-table-container">
                <div id="projectsContent">
                    <div class="loading">Loading projects...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- CHAT TRIGGER BUTTON -->
    <button class="chat-trigger" id="chatTrigger" onclick="toggleChatSidebar()">
        💬
    </button>

    <!-- RIGHT SIDEBAR CHAT -->
    <div class="chat-sidebar" id="chatSidebar">
        <div class="chat-sidebar-header">
            <h3 class="chat-sidebar-title">Assistant</h3>
            <button class="chat-close" onclick="toggleChatSidebar()">&times;</button>
        </div>
        <div class="chat-sidebar-content">
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message agent">
                    Hi! I'm your ProWorkflow AI assistant. I can help you analyze projects, identify bottlenecks, suggest actions, and answer questions about your dashboard data. What can I help you with?
                </div>
            </div>
            <div class="chat-input-container">
                <textarea class="chat-input" id="chatInput" placeholder="Ask me about your projects..." rows="1"></textarea>
                <button class="chat-send" id="chatSend" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <!-- TASK MESSAGE MODAL -->
    <div id="taskMessageModal" class="message-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="taskModalTitle">Task Messages</div>
                <button class="modal-close" onclick="closeTaskMessageModal()">&times;</button>
            </div>
            <div class="modal-body" id="taskModalBody">
                <div class="loading">Loading messages...</div>
            </div>
        </div>
    </div>
		
		<script>
        let allProjects = [];
        let availableManagers = [];
        let expandedProjects = new Set();
        let currentSort = { field: 'idle', direction: 'desc' };
			
        let chatHistory = [];

    function toggleChatSidebar() {
        const sidebar = document.getElementById('chatSidebar');
        const trigger = document.getElementById('chatTrigger');
        const mainContainer = document.getElementById('mainContainer');

        if (!sidebar || !trigger) {
            console.warn('⚠️ Chat sidebar elements missing');
            return;
        }

        const isOpen = sidebar.classList.toggle('open');

        trigger.classList.toggle('chat-open', isOpen);
        trigger.setAttribute('aria-expanded', String(isOpen));

        if (mainContainer) {
            mainContainer.classList.toggle('chat-open', isOpen);
        }

        sidebar.setAttribute('aria-hidden', String(!isOpen));
    }

    window.toggleChatSidebar = toggleChatSidebar;
// TODO: Replace with the actual IDs from your PWF account

			
const ACTIVE_STATUS_ID = 1;     // check a task that is "Active" to confirm
const COMPLETE_STATUS_ID = 3;   // check a task that is "Complete" to confirm
			
			
			
// PHASE 2: Status Update Functionality

let statusOptionsCache = null;

async function loadStatusOptions() {
    // Return cached if valid
    if (statusOptionsCache && statusOptionsCache.length > 0) {
        return statusOptionsCache;
    }

    try {
        console.log('🔄 Loading status options...');
        const response = await fetch('/api/rest/status-options');
        const data = await response.json();

        if (data.statuses && data.statuses.length > 0) {
            statusOptionsCache = data.statuses;
            console.log(`✅ Loaded ${statusOptionsCache.length} status options`);
            return statusOptionsCache;
        } else {
            console.warn('⚠️ No statuses returned from API');
            return [];
        }
    } catch (error) {
        console.error('❌ Failed to load status options:', error);
        return [];
    }
}

			
    function toggleChatSidebar() {
      const sidebar = document.getElementById('chatSidebar');
      if (!sidebar) return;

      const trigger = document.getElementById('chatTrigger');
      const mainContainer = document.getElementById('mainContainer');
      const isOpen = sidebar.classList.toggle('open');

      if (trigger) {
        trigger.classList.toggle('chat-open', isOpen);
        trigger.setAttribute('aria-expanded', String(isOpen));
      }

      if (mainContainer) {
        mainContainer.classList.toggle('chat-open', isOpen);
      }
    }

    // 🔹 Helper to append messages to the chat window
    function addMessage(text, sender) {
      const messages = document.getElementById('chatMessages');

      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${sender}`;
      messageDiv.textContent = text;

      messages.appendChild(messageDiv);
      messages.scrollTop = messages.scrollHeight; // auto-scroll
    }

    // 🔹 Update sendMessage to use the backend API
    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const userMessage = input.value.trim();
      if (!userMessage) return;

      addMessage(userMessage, "user");
      input.value = "";

      try {
        const response = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: userMessage, history: chatHistory })
        });
        const data = await response.json();
        const reply = data.reply.content || "No reply";

        addMessage(reply, "agent");
        chatHistory.push({ role: "user", content: userMessage });
        chatHistory.push({ role: "assistant", content: reply });
      } catch (err) {
        addMessage("⚠️ Error talking to assistant", "agent");
      }
    }

    function toggleChatSidebar() {
      const sidebar = document.getElementById('chatSidebar');
      const trigger = document.getElementById('chatTrigger');
      const mainContainer = document.getElementById('mainContainer');

      if (!sidebar) {
        console.warn('toggleChatSidebar: #chatSidebar not found');
        return;
      }

      const isOpen = sidebar.classList.toggle('open');
      sidebar.setAttribute('aria-hidden', String(!isOpen));

      if (trigger) {
        trigger.classList.toggle('chat-open', isOpen);
        trigger.setAttribute('aria-expanded', String(isOpen));
      }

      if (mainContainer) {
        mainContainer.classList.toggle('chat-open', isOpen);
      }
    }

    window.toggleChatSidebar = toggleChatSidebar;
			
			    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
			
        // Create ProWorkflow-style dropdown
        function createStatusDropdown(statuses, currentStatusText, onSelect) {
            const dropdown = document.createElement('div');
            dropdown.className = 'pwf-status-dropdown';
            
            statuses.forEach(status => {
                const item = document.createElement('div');
                item.className = 'status-dropdown-item';
                item.style.background = '#' + status.color;
                item.style.color = 'white';
                item.textContent = status.name;
                
                if (status.name === currentStatusText) {
                    item.classList.add('current');
                }
                
                item.onclick = () => onSelect(status);
                dropdown.appendChild(item);
            });
            
            return dropdown;
        }

// FIXED: Status dropdown positioning that follows scroll
document.addEventListener('click', async function(e) {
    // Remove any existing dropdowns
    document.querySelectorAll('.pwf-status-dropdown').forEach(d => d.remove());
    
    if (e.target.classList.contains('status-badge')) {
        e.preventDefault();
        e.stopPropagation();
        
        const statusBadge = e.target;
        const projectId = statusBadge.getAttribute('data-project-id');
        const currentStatusText = e.target.textContent.trim();
        
        console.log(`📋 Status badge clicked - Project: ${projectId}, Current: ${currentStatusText}`);
        
        // Load status options
        const statuses = await loadStatusOptions();
        if (statuses.length === 0) {
            alert('Unable to load status options. Please try again.');
            return;
        }
        
        // Create dropdown
        const dropdown = createStatusDropdown(statuses, currentStatusText, async (selectedStatus) => {
            dropdown.remove();
            await updateProjectStatus(projectId, selectedStatus, e.target);
        });
        
// Position dropdown near the clicked badge (FIXED for scroll)
        document.body.appendChild(dropdown);
        const rect = e.target.getBoundingClientRect();

        // Account for page scroll
        dropdown.style.position = 'absolute';
        dropdown.style.left = (rect.left + window.scrollX) + 'px';
        dropdown.style.top = (rect.bottom + window.scrollY + 5) + 'px';
        dropdown.style.zIndex = '10000';
        
        // Ensure dropdown stays within viewport
        const dropdownRect = dropdown.getBoundingClientRect();
        if (dropdownRect.right > window.innerWidth) {
            dropdown.style.left = (window.innerWidth - dropdownRect.width - 10 + window.scrollX) + 'px';
        }
        if (dropdownRect.bottom > window.innerHeight) {
            dropdown.style.top = (rect.top + window.scrollY - dropdownRect.height - 5) + 'px';
        }
    }
});

// ENHANCED: Close dropdown on scroll to prevent positioning issues
window.addEventListener('scroll', function() {
    document.querySelectorAll('.pwf-status-dropdown').forEach(d => d.remove());
});

// Also close on window resize
window.addEventListener('resize', function() {
    document.querySelectorAll('.pwf-status-dropdown').forEach(d => d.remove());
});

// Update project status from dashboard
async function updateProjectStatus(projectId, statusObj, badgeElement) {
  console.log('WILL UPDATE → project', projectId, 'to status NAME:', statusObj?.name, 'ID:', statusObj?.id);
	console.log('=== updateProjectStatus START ===');
    console.log('Project ID:', projectId, 'Status:', statusObj);

    if (!projectId) {
        alert(`Cannot update status: Invalid project ID (${projectId}). Please refresh the page and try again.`);
        return;
    }

    const apiUrl = `/api/rest/project/${projectId}/status`;
    console.log('API URL:', apiUrl);

    // Optimistic UI update
    const originalText = badgeElement.textContent;
    const originalColor = badgeElement.style.background;

    badgeElement.textContent = statusObj.name;
    badgeElement.style.background = '#' + statusObj.color;

    try {
        const response = await fetch(apiUrl, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ statusId: statusObj.id })
        });

        const result = await response.json();
        console.log('Response:', result);

if (result.success) {
    console.log('✅ Status updated successfully');

    // Refresh just this project row
    setTimeout(async () => {
        try {
            const res = await fetch(`/api/rest/project/${projectId}`);
            const data = await res.json();
					console.log('🔍 Reloaded project data:', data);


            if (data.project) {
                console.log('🔄 Updated project data:', data.project);

                // Update badge text + color in case backend differs
                badgeElement.textContent = data.project.customstatus || statusObj.name;
                if (data.project.customstatuscolor) {
                    badgeElement.style.background = '#' + data.project.customstatuscolor;
                }
            }
        } catch (err) {
            console.error('Failed to reload single project', err);
        }
    }, 500);
}

			
			else {
            throw new Error(result.error || 'Update failed');
        }
    } catch (error) {
        console.error('❌ Error updating status:', error);

        // Rollback optimistic update
        badgeElement.textContent = originalText;
        badgeElement.style.background = originalColor;

        alert('Failed to update status: ' + error.message);
    }

    console.log('=== updateProjectStatus END ===');
}

    });


        // THREADING HELPER FUNCTIONS
			
			

function updateStats(data) {
    const statsContainer = document.getElementById('stats');
    if (!statsContainer) return;

    const projects = data.projects || [];
    
    const totalProjects = projects.length;
    const overdueProjects = projects.filter(p => p.isOverdue).length;
    const staleProjects = projects.filter(p => p.communicationHealth === 'stale').length;
    const activeProjects = projects.filter(p => p.communicationHealth === 'active').length;

    statsContainer.innerHTML = `
        <div class="stat-card">
            <div class="stat-number">${totalProjects}</div>
            <div class="stat-label">Total Projects</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${activeProjects}</div>
            <div class="stat-label">Active Communication</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${staleProjects}</div>
            <div class="stat-label">Stale Projects</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${overdueProjects}</div>
            <div class="stat-label">Overdue</div>
        </div>
    `;
}
			

function getDaysClass(days) {
    if (days === 0 || days === null || days === undefined) return '';
    if (days > 30) return 'days-badge urgent';
    if (days > 14) return 'days-badge warning';
    return 'days-badge';
}
			
			

function getTaskContextMessages(projectMessages, taskDetails) {
    if (!projectMessages || !projectMessages.length) {
        return [];
    }
    
    const taskTitle = (taskDetails.name || '').toLowerCase();
    const taskAssignees = (taskDetails.contacts || []).map(c => c.name?.toLowerCase()).filter(Boolean);
    
    console.log(`Filtering messages for task "${taskDetails.name}"`);
    console.log(`Task assignees: [${taskAssignees.join(', ')}]`);
    
    const commonWords = ['the','and','or','but','in','on','at','to','for','of','with','by','a','an','is','are','was','were','be','been','have','has','had','do','does','did','will','would','could','should','may','might','can','must','shall','design','task','project','update','create','add','remove','edit','review'];
    const taskKeywords = taskTitle
        .split(/[\s\-_,()[\]{}|\\/:;"'<>?=+*&^%$#@!~`]+/)
        .map(word => word.toLowerCase().trim())
        .filter(word => word.length > 2 && !commonWords.includes(word))
        .slice(0, 5);
    
    console.log(`Task keywords: [${taskKeywords.join(', ')}]`);
    
    const relevantMessages = projectMessages.filter(message => {
        const messageContent = (message.content || '').toLowerCase();
        const messageAuthor = (message.authorname || '').toLowerCase();
        
        let relevanceScore = 0;
        
        // Check if message mentions task assignees
        for (const assignee of taskAssignees) {
            if (messageContent.includes(assignee) || messageAuthor.includes(assignee)) {
                relevanceScore += 10;
                break;
            }
        }
        
        // Check for keyword matches
        let keywordMatches = 0;
        for (const keyword of taskKeywords) {
            if (messageContent.includes(keyword)) {
                keywordMatches++;
                relevanceScore += 3;
            }
        }
        
        // Check if author is assignee
        if (taskAssignees.some(assignee => messageAuthor.includes(assignee))) {
            relevanceScore += 8;
        }
        
        return relevanceScore >= 5;
    });
    
    console.log(`Found ${relevantMessages.length} relevant messages out of ${projectMessages.length} total project messages`);
    
    return relevantMessages;
}
			
			
        function buildMessageThreads(messages) {
					
            const messageMap = new Map();
            const rootMessages = [];
            
            const sortedMessages = messages.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            sortedMessages.forEach(message => {
                messageMap.set(message.id, {
                    ...message,
                    replies: []
                });
            });
            
            sortedMessages.forEach(message => {
                const messageObj = messageMap.get(message.id);
                
                if (message.originalmessageid && messageMap.has(message.originalmessageid)) {
                    const parent = messageMap.get(message.originalmessageid);
                    parent.replies.push(messageObj);
                } else {
                    rootMessages.push(messageObj);
                }
            });
            
            return rootMessages;
        }
			
			
			
			

        function renderThreadedMessages(threadedMessages, tasks = []) {
            return threadedMessages.map(message => {
                let messageHtml = `
                    <div class="message-item">
                        <img src="${message.authorimage}" alt="${message.authorname}" class="message-avatar" onerror="this.style.display='none'">
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-author-name message-author ${message.authortype}">${message.authorname}</span>
                                <span class="message-date">${new Date(message.date).toLocaleDateString()} ${new Date(message.date).toLocaleTimeString()}</span>
                            </div>
                            <div class="message-text">${stripHtmlTags(message.content)}</div>
                            ${message.files && message.files.length > 0 ? `
                                <div class="message-files">
                                    ${message.files.map(file => `
                                        <a href="${file.link}" target="_blank" class="message-file">
                                            📎 ${file.name} (${formatFileSize(file.size)})
                                        </a>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                if (message.replies && message.replies.length > 0) {
                    const repliesHtml = message.replies.map(reply => `
                        <div class="message-item thread-reply">
                            <img src="${reply.authorimage}" alt="${reply.authorname}" class="message-avatar" onerror="this.style.display='none'">
                            <div class="message-content">
                                <div class="message-header">
                                    <span class="message-author-name message-author ${reply.authortype}">${reply.authorname}</span>
                                    <span class="message-date">${new Date(reply.date).toLocaleDateString()} ${new Date(reply.date).toLocaleTimeString()}</span>
                                </div>
                                <div class="message-text">${stripHtmlTags(reply.content)}</div>
                                ${reply.files && reply.files.length > 0 ? `
                                    <div class="message-files">
                                        ${reply.files.map(file => `
                                            <a href="${file.link}" target="_blank" class="message-file">
                                                📎 ${file.name} (${formatFileSize(file.size)})
                                            </a>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `).join('');
                    
                    messageHtml += repliesHtml;
                }
                
                return messageHtml;
            }).join('');
        }

        function stripHtmlTags(html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            return tempDiv.textContent || tempDiv.innerText || '';
        }

        
			
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

       

        function updateManagerDropdown() {
            const managerSelect = document.getElementById('managerSelect');
            if (!managerSelect) return;

            const previousValue = managerSelect.value;
            const previousLabel = managerSelect.selectedIndex >= 0
                ? managerSelect.options[managerSelect.selectedIndex].textContent.trim()
                : null;

            managerSelect.innerHTML = '';

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'All Team Members';
            managerSelect.appendChild(defaultOption);

            const managerOptions = [];
            const seenKeys = new Set();

            const addManagerOption = (value, label) => {
                if (value === null || value === undefined) return;

                const normalizedValue = String(value).trim();
                const normalizedLabel = (label ?? '').toString().trim();
                const keySource = normalizedValue || normalizedLabel;
                if (!keySource) return;

                const key = keySource.toLowerCase();
                if (seenKeys.has(key)) return;

                managerOptions.push({
                    value: normalizedValue || normalizedLabel,
                    label: normalizedLabel || normalizedValue || 'Unknown'
                });
                seenKeys.add(key);
            };

            if (Array.isArray(availableManagers) && availableManagers.length > 0) {
                availableManagers.forEach(manager => {
                    if (!manager) return;

                    if (typeof manager === 'string') {
                        addManagerOption(manager, manager);
                        return;
                    }

                    if (typeof manager === 'object') {
                        const rawValue = manager.id ?? manager.managerId ?? manager.managerid ?? manager.value ?? manager.email;
                        const label = (manager.name ?? manager.label ?? manager.displayName ?? manager.fullName ?? manager.owner ?? manager.value ?? manager.email ?? rawValue);

                        addManagerOption(
                            rawValue !== undefined && rawValue !== null ? rawValue : label,
                            label
                        );
                    }
                });
            }

            if (managerOptions.length === 0 && Array.isArray(allProjects) && allProjects.length > 0) {
                allProjects.forEach(project => {
                    if (!project) return;

                    const rawValue = project.managerId ?? project.managerid ?? project.owner ?? project.manager ?? project.managerName;
                    const label = (project.owner || project.manager || project.managerName || 'Unassigned').toString().trim();
                    const valueToUse = rawValue !== undefined && rawValue !== null ? rawValue : label;

                    addManagerOption(valueToUse, label);
                });
            }

            managerOptions.sort((a, b) => a.label.localeCompare(b.label, undefined, { sensitivity: 'base' }));

            managerOptions.forEach(optionData => {
                const option = document.createElement('option');
                option.value = String(optionData.value);
                option.textContent = optionData.label;
                managerSelect.appendChild(option);
            });

            managerSelect.value = previousValue;

            if (managerSelect.value !== previousValue && previousLabel) {
                const normalizedPreviousLabel = previousLabel.toLowerCase();
                const matchingOption = Array.from(managerSelect.options).find(option =>
                    option.textContent.trim().toLowerCase() === normalizedPreviousLabel
                );

                if (matchingOption) {
                    managerSelect.value = matchingOption.value;
                }
            }
        }




        async function loadProjects() {
                                            console.log("🚀 loadProjects() triggered, about to fetch");
                                            console.log('🚀 loadProjects() function triggered');

            const manager = document.getElementById('managerSelect').value;
            
            document.getElementById('projectsContent').innerHTML = '<div class="loading">Loading projects...</div>';
            
            try {
                let url = '/api/rest/projects-table';
                const params = new URLSearchParams();
                
                if (manager) params.append('manager', manager);
                if (currentSort.field) params.append('sort', currentSort.field);
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                console.log('Loading with sort:', currentSort.field, currentSort.direction);
                
                const response = await fetch(url);
                const data = await response.json();
                
                allProjects = data.projects || [];
                availableManagers = data.availableManagers || [];
                
                console.log('✅ Projects loaded:', allProjects.length);
                
                updateManagerDropdown();
                updateStats(data);
                renderProjects(allProjects);
                
            } catch (error) {
                console.error('❌ Error loading projects:', error);
                document.getElementById('projectsContent').innerHTML = 
                    '<div class="no-projects">Error loading projects. Please try again.</div>';
            }
        }

        function sortByHeader(field) {
            console.log('Sorting by header:', field);
            
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }
            
            const dropdown = document.getElementById('sortSelect');
            dropdown.value = field;
            
            loadProjects();
        }

        function getProjectCommunication(project) {
            if (!project.lastMessageDate) {
                return {
                    status: 'none',
                    text: 'No Messages',
                    class: 'none',
                    extraInfo: ''
                };
            }
            
            const days = project.daysSinceLastMessage;
            let status, text, className;
            
            if (days <= 2) {
                status = 'active';
                text = 'Active';
                className = 'active';
            } else if (days <= 7) {
                status = 'normal';
                text = 'Normal';
                className = 'normal';
            } else {
                status = 'stale';
                text = 'Stale';
                className = 'stale';
            }
            
            const authorClass = project.lastMessageType === 'staff' ? 'staff' : 'client';
            const extraInfo = `<span class="message-author ${authorClass}">${project.lastMessageAuthor}</span> • ${days}d ago`;
            
            return {
                status: status,
                text: text,
                class: className,
                extraInfo: extraInfo
            };
        }

			
			
// Fixed renderProjects function - extract this section from your dashboard.html
function renderProjects(projects) {
    console.log('🎨 Rendering projects:', projects.length);
    
    if (!projects || projects.length === 0) {
        document.getElementById('projectsContent').innerHTML = 
            '<div class="no-projects">No projects found with current filters.</div>';
        return;
    }

    const container = document.getElementById('projectsContent');
    container.innerHTML = '';
    
    const table = document.createElement('table');
    table.className = 'projects-table';
    
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    
    const headerConfig = [
        { text: '', field: null },
        { text: 'Project #', field: 'number' },
        { text: 'Title', field: 'title' },
        { text: 'Manager', field: 'manager' },
        { text: 'Custom Status', field: 'status' },
        { text: 'Start', field: null },
        { text: 'Due Date', field: 'dueDate' },
        { text: 'Communication', field: 'communication' },
        { text: 'Days Idle', field: 'idle' }
    ];

    headerConfig.forEach(config => {
        const th = document.createElement('th');
        th.textContent = config.text;
        
        if (config.field) {
            th.className = 'sortable';
            th.onclick = () => sortByHeader(config.field);
            
            const indicator = document.createElement('span');
            indicator.className = 'sort-indicator';
            
            if (currentSort.field === config.field) {
                indicator.className += ' active';
                indicator.textContent = currentSort.direction === 'asc' ? ' ↑' : ' ↓';
            } else {
                indicator.textContent = ' ↕';
            }
            
            th.appendChild(indicator);
        }
        
        headerRow.appendChild(th);
    });

    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    const tbody = document.createElement('tbody');
    
    projects.forEach((project, index) => {
        const row = document.createElement('tr');
        
        const isRush = project.customStatus && project.customStatus.toLowerCase().includes('rush');
        if (isRush) {
            row.style.backgroundColor = '#fef3c7';
        }
        
        const expandCell = document.createElement('td');
        const expandBtn = document.createElement('button');
        expandBtn.className = 'expand-btn';
        expandBtn.onclick = () => toggleProject(project.projectId, expandBtn);
        
        const arrow = document.createElement('div');
        arrow.className = 'expand-arrow';
        expandBtn.appendChild(arrow);
        expandCell.appendChild(expandBtn);
        row.appendChild(expandCell);
        
        const communicationInfo = getProjectCommunication(project);
        
        // FIXED: Use project.id consistently (confirmed via API test)
        console.log(`🔍 Project ${index}: ID=${project.id}, Number=${project.number}, Title=${project.title}`);
        
        const cells = [
            { content: project.number, class: 'project-number' },
            { 
                content: project.title, 
                link: project.projectUrl, 
                class: 'project-link'
            },
            { content: project.owner },
            { 
                content: project.customstatus || project.customStatus || 'Unknown', 
                style: `background: ${project.statusColor}; color: white;`, 
                class: 'status-badge', 

dataProjectId: project.projectId || project.originalId || project.id || project.number
							
							
            },
						{ content: project.startDate || project.startdate || '-' },
            { content: project.dueDate || '-' },
            { 
                content: communicationInfo.text, 
                class: `communication-badge ${communicationInfo.class}`,
                extraContent: communicationInfo.extraInfo
            },
            { content: project.daysIdle > 0 ? project.daysIdle + ' days' : 'Active', class: getDaysClass(project.daysIdle) }
        ];

        cells.forEach(cellData => {
            const td = document.createElement('td');
            
            if (cellData.link) {
                const link = document.createElement('a');
                link.href = cellData.link;
                link.target = '_blank';
                link.className = cellData.class || '';
                link.textContent = cellData.content;
                td.appendChild(link);
            } else {
                const span = document.createElement('span');
                if (cellData.class) span.className = cellData.class;
                if (cellData.style) span.setAttribute('style', cellData.style);
if (cellData.dataProjectId) span.setAttribute('data-project-id', cellData.dataProjectId);
                span.textContent = cellData.content;
                td.appendChild(span);
                
                if (cellData.extraContent) {
                    const extraDiv = document.createElement('div');
                    extraDiv.className = 'last-message-info';
                    extraDiv.innerHTML = cellData.extraContent;
                    td.appendChild(extraDiv);
                }
            }
            
            row.appendChild(td);
        });

        tbody.appendChild(row);
        
        const expansionRow = document.createElement('tr');
        const expansionCell = document.createElement('td');
        expansionCell.colSpan = 9;
        
        const expansionSection = document.createElement('div');
        expansionSection.className = 'project-expansion';
        expansionSection.id = `expansion-${project.projectId}`;
        
        expansionCell.appendChild(expansionSection);
        expansionRow.appendChild(expansionCell);
        tbody.appendChild(expansionRow);
    });
    
    table.appendChild(tbody);
    container.appendChild(table);
    
    console.log('✅ Projects rendered successfully');
}
			
			
// NEW: Missing toggleProject function that renderProjects is calling
async function toggleProject(projectId, expandBtn) {
    const expansionSection = document.getElementById(`expansion-${projectId}`);
    
    if (expandedProjects.has(projectId)) {
        // Collapse
        expandedProjects.delete(projectId);
        expansionSection.classList.remove('expanded');
        expandBtn.classList.remove('expanded');
    } else {
        // Expand and load content
        expandedProjects.add(projectId);
        expansionSection.classList.add('expanded');
        expandBtn.classList.add('expanded');
        
        // Load enhanced project content
        expansionSection.innerHTML = '<div class="loading">Loading project details...</div>';
        await loadProjectExpansion(projectId);
    }
}

// NEW: Enhanced project expansion with tasks
async function loadProjectExpansion(projectId) {
    try {
        // Load project details, tasks, and messages in parallel
        const [projectResponse, tasksResponse, messagesResponse] = await Promise.all([
            fetch(`/api/rest/project/${projectId}`),
            fetch(`/api/rest/project/${projectId}/tasks`),
            fetch(`/api/rest/project/${projectId}/messages`)
        ]);
        
        const projectData = await projectResponse.json();
        const tasksData = await tasksResponse.json();
        const messagesData = await messagesResponse.json();
        
        const expansionSection = document.getElementById(`expansion-${projectId}`);
        
        let html = '<div class="expansion-content">';
        
        // Project Description
        if (projectData.project?.description) {
            html += `
                <div class="message-timeline">
                    <div class="timeline-header">
                        <div class="timeline-title">Project Description</div>
                    </div>
                    <div style="padding: 1rem; color: #475569; line-height: 1.4;">
                        ${projectData.project.description}
                    </div>
                </div>
            `;
        }
        
// Recent Messages with Threading (FIXED: Newest at bottom)
        if (messagesData.messages?.length > 0) {
            const recentMessages = messagesData.messages
                .sort((a, b) => new Date(a.date) - new Date(b.date))  // Changed: a.date - b.date (oldest first)
                .slice(-5);  // Changed: Take last 5 instead of first 5
            
            html += `
                <div class="message-timeline">
                    <div class="timeline-header">
                        <div class="timeline-title">Recent Messages (${messagesData.count || 0} total)</div>
                    </div>
                    ${renderRecentMessages(recentMessages, tasksData.tasks)}
                </div>
            `;
        }
        
        // Tasks Table
        if (tasksData.tasks?.length > 0) {
            const tasksToShow = tasksData.tasks.slice(0, 20);
            
            html += `
                <div class="message-timeline">
                    <div class="timeline-header">
                        <div class="timeline-title">Tasks (${tasksData.tasks.length} total)</div>
                    </div>
                    ${renderTasksTable(tasksToShow, projectId)}
                </div>
            `;
            
            if (tasksData.tasks.length > 20) {
                html += `<div style="padding: 1rem; color: #64748b; font-style: italic; text-align: center;">Showing first 20 of ${tasksData.tasks.length} tasks</div>`;
            }
        } else {
            html += `
                <div class="message-timeline">
                    <div class="timeline-header">
                        <div class="timeline-title">Tasks</div>
                    </div>
                    <div style="padding: 2rem; text-align: center; color: #64748b; font-style: italic;">No tasks found for this project</div>
                </div>
            `;
        }
        
        html += '</div>';
        expansionSection.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading project expansion:', error);
        const expansionSection = document.getElementById(`expansion-${projectId}`);
        expansionSection.innerHTML = '<div class="expansion-content"><div style="color: #ef4444; padding: 2rem; text-align: center;">Error loading project details</div></div>';
    }
}

function renderRecentMessages(messages, tasks = []) {
    // Build message threads
    const messageMap = new Map();
    const rootMessages = [];
    
    // First pass: create message objects
    messages.forEach(message => {
        messageMap.set(message.id, {
            ...message,
            replies: []
        });
    });
    
    // Second pass: build thread structure
    messages.forEach(message => {
        const messageObj = messageMap.get(message.id);
        
        if (message.originalmessageid && messageMap.has(message.originalmessageid)) {
            // This is a reply - add to parent's replies
            const parent = messageMap.get(message.originalmessageid);
            parent.replies.push(messageObj);
        } else {
            // This is a root message
            rootMessages.push(messageObj);
        }
    });
    
    // Sort root messages by date (oldest first)
    rootMessages.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    // Sort replies within each thread by date (oldest first)
    rootMessages.forEach(rootMessage => {
        rootMessage.replies.sort((a, b) => new Date(a.date) - new Date(b.date));
    });
    
    // Render threaded messages
    return rootMessages.map(rootMessage => {
        let html = renderSingleMessage(rootMessage, tasks, false); // false = not a reply
        
        // Add replies
        if (rootMessage.replies.length > 0) {
            html += rootMessage.replies.map(reply => 
                renderSingleMessage(reply, tasks, true) // true = is a reply
            ).join('');
        }
        
        return html;
    }).join('');
}

// Helper function to render a single message
function renderSingleMessage(message, tasks, isReply) {
    const messageDate = new Date(message.date).toLocaleDateString();
    const messageTime = new Date(message.date).toLocaleTimeString();
    
    // Find task title for root messages only
    let taskTitle = null;
    if (!isReply && tasks && tasks.length > 0) {
        const messageContent = (message.content || '').toLowerCase();
        
        const taskMatches = tasks.map(task => {
            const taskTitleLower = (task.title || '').toLowerCase();
            let score = 0;
            
            const taskWords = taskTitleLower.split(/[\s\-_,()[\]{}|\\/:;"'<>?=+*&^%$#@!~`]+/)
                .filter(word => word.length > 2)
                .filter(word => !['the', 'and', 'or', 'but', 'for', 'with', 'from', 'this', 'that'].includes(word));
            
            taskWords.forEach(word => {
                if (messageContent.includes(word)) {
                    score += word.length;
                }
            });
            
            return { task, score };
        });
        
        const bestMatch = taskMatches.find(match => match.score > 0);
        if (bestMatch) {
            taskTitle = bestMatch.task.title;
        }
    }
    
return `
    <div class="message-item ${isReply ? 'thread-reply' : 'root-message'}">
        <div class="message-content">
            <div class="message-header">
                    <span class="message-author-name message-author ${message.authortype}">
                        ${isReply ? '↳ ' : ''}${message.authorname}
                    </span>
                    <span class="message-date">${messageDate} ${messageTime}</span>
                </div>
                ${taskTitle ? `
                    <div class="message-task-context">
                        📋 ${taskTitle}
                    </div>
                ` : ''}
                <div class="message-text">${stripHtmlTags(message.content)}</div>
                ${message.files && message.files.length > 0 ? `
                    <div class="message-files">
                        ${message.files.map(file => `
                            <a href="${file.link}" target="_blank" class="message-file">
                                📎 ${file.name} (${formatFileSize(file.size) || 'unknown size'})
                            </a>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}


function renderTasksTable(tasks, projectId) {
    let html = `
        <table class="projects-table">
            <thead>
                <tr>
									<th style="width: 40px;"></th>
									<th style="width: 60px;">Number</th>
									<th style="width: 80px;">Complete</th>
									<th style="width: 250px;">Title</th>
									<th style="width: 100px;">Priority</th>
									<th style="width: 120px;">Assigned</th>
									<th style="width: 100px;">Start Date</th>
									<th style="width: 100px;">Due Date</th>
									<th style="width: 80px;">Time Alloc</th>
									<th style="width: 80px;">Time Spent</th>
									<th style="width: 60px;">Messages</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    tasks.forEach(task => {
        const isCompleted = task.status === 'complete';
        const isOverdue = task.dueDate && new Date(task.dueDate) < new Date() && !isCompleted;
        
        // Format dates for editing
        const startDateISO = task.startDate ? new Date(task.startDate).toISOString().split('T')[0] : '';
        const dueDateISO = task.dueDate ? new Date(task.dueDate).toISOString().split('T')[0] : '';
        const startDateDisplay = task.startDate ? new Date(task.startDate).toLocaleDateString() : '-';
        const dueDateDisplay = task.dueDate ? new Date(task.dueDate).toLocaleDateString() : '-';
        
html += `
    <tr style="${isOverdue ? 'background-color: #fef2f2;' : ''} ${isCompleted ? 'opacity: 0.7;' : ''}">
        <td>
            <button class="expand-btn task-expand-btn" onclick="toggleTask(${task.id}, this)">
                <div class="expand-arrow"></div>
            </button>
        </td>
					<td>${task.order || task.order1 || index + 1}</td>
					<td style="text-align: center;">
							<input type="checkbox" ${isCompleted ? 'checked' : ''} 
										 onchange="updateTaskCompletion(${task.id}, this.checked, this)"
										 style="transform: scale(1.2); cursor: pointer;">
					</td>
					<td style="${isCompleted ? 'text-decoration: line-through;' : ''}">${task.title}</td>
					<td>${task.priority || 'Normal'}</td>
					<td>${task.assignedTo || 'Unassigned'}</td>
					<td>
							<span class="editable-date" onclick="editTaskDate('start', ${task.id}, '${startDateISO}', this)">
									${startDateDisplay}
							</span>
					</td>
					<td style="${isOverdue ? 'color: #ef4444; font-weight: 600;' : ''}">
							<span class="editable-date" onclick="editTaskDate('due', ${task.id}, '${dueDateISO}', this)">
									${dueDateDisplay}
							</span>
					</td>
					<td style="font-family: monospace; font-size: 0.8rem;">${task.timeAllocated || '0:00'}</td>
					<td style="font-family: monospace; font-size: 0.8rem;">${task.timeSpent || '0:00'}</td>
					<td>💬</td>
    </tr>
`;
    });
    
    html += '</tbody></table>';
    return html;
}

// Task date editing
function editTaskDate(dateType, taskId, currentValue, element) {
    const input = document.createElement('input');
    input.type = 'date';
    input.value = currentValue;
    input.style.cssText = 'position: absolute; z-index: 1000; padding: 0.5rem; border: 2px solid #667eea; border-radius: 4px;';
    
    const rect = element.getBoundingClientRect();
    input.style.left = rect.left + 'px';
    input.style.top = (rect.bottom + window.scrollY + 5) + 'px';
    
    document.body.appendChild(input);
    input.focus();
    input.click();
    
    input.onchange = async () => {
        if (input.value !== currentValue) {
            await updateTaskDate(taskId, dateType, input.value);
            element.textContent = input.value ? new Date(input.value).toLocaleDateString() : '-';
        }
        document.body.removeChild(input);
    };
    
    input.onblur = () => {
        setTimeout(() => {
            if (document.body.contains(input)) {
                document.body.removeChild(input);
            }
        }, 200);
    };
}

async function updateTaskDate(taskId, dateType, newDate) {
    try {
        const field = dateType === 'start' ? 'startdate' : 'duedate';
        const response = await fetch(`/api/rest/task/${taskId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ [field]: newDate })
        });
        
        const result = await response.json();
        if (!result.success) {
            throw new Error(result.error || 'Update failed');
        }
        
        console.log(`Updated task ${taskId} ${dateType} date`);
    } catch (error) {
        console.error(`Error updating ${dateType} date:`, error);
        alert(`Failed to update ${dateType} date: ${error.message}`);
    }
}


async function updateTaskCompletion(taskId, isCompleted, checkboxElement) {
  const endpoint = isCompleted
    ? `/api/rest/task/${taskId}/complete`
    : `/api/rest/task/${taskId}/reactivate`;

  const body = isCompleted
    ? JSON.stringify({ completedate: new Date().toISOString().split('T')[0] })
    : null;

  try {
    const response = await fetch(endpoint, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body
    });

    const result = await response.json();
    console.log('[DEBUG] Task update response:', result);

    if (!result.success && result.status !== 'Success') {
      throw new Error(result.error || result.message || 'Update failed');
    }

    // Update UI
    const row = checkboxElement.closest('tr');
    const titleCell = row.children[1];
    if (isCompleted) {
      row.style.opacity = '0.7';
      titleCell.style.textDecoration = 'line-through';
    } else {
      row.style.opacity = '1';
      titleCell.style.textDecoration = 'none';
    }
  } catch (err) {
    console.error(`❌ Failed to update task ${taskId}:`, err);
    checkboxElement.checked = !isCompleted; // rollback
    alert(`Failed to update task completion: ${err.message}`);
  }
}

	
	
		
	
	// Track expanded tasks
let expandedTasks = new Set();

async function toggleTask(taskId, expandBtn) {
    console.log(`Toggling task ${taskId}`);
    
    // Find the task row and create expansion row if needed
    const taskRow = expandBtn.closest('tr');
    let expansionRow = taskRow.nextElementSibling;
    
    // Check if next row is our expansion row
    if (!expansionRow || !expansionRow.classList.contains('task-expansion-row')) {
        // Create new expansion row
        expansionRow = document.createElement('tr');
        expansionRow.className = 'task-expansion-row';
        expansionRow.style.display = 'none';
        
        const expansionCell = document.createElement('td');
        expansionCell.colSpan = 11; // All columns
        
        const expansionContent = document.createElement('div');
        expansionContent.className = 'task-expansion-content';
        expansionContent.id = `task-expansion-${taskId}`;
        
        expansionCell.appendChild(expansionContent);
        expansionRow.appendChild(expansionCell);
        
        // Insert after current row
        taskRow.parentNode.insertBefore(expansionRow, taskRow.nextSibling);
    }
    
    if (expandedTasks.has(taskId)) {
        // Collapse
        expandedTasks.delete(taskId);
        expansionRow.style.display = 'none';
        expandBtn.classList.remove('expanded');
    } else {
        // Expand and load content
        expandedTasks.add(taskId);
        expansionRow.style.display = 'table-row';
        expandBtn.classList.add('expanded');
        
        // Load task messages
        const expansionContent = document.getElementById(`task-expansion-${taskId}`);
        expansionContent.innerHTML = '<div class="loading">Loading task messages...</div>';
        await loadTaskMessages(taskId, expansionContent);
    }
}

async function loadTaskMessages(taskId, container) {
    try {
        console.log(`Loading messages for task ${taskId}`);
        
        // Load task messages and task details
        const [taskMessagesResponse, taskDetailsResponse] = await Promise.all([
            fetch(`/api/rest/task/${taskId}/messages`),
            fetch(`/api/rest/task/${taskId}`)
        ]);
        
        const taskMessagesData = await taskMessagesResponse.json();
        const taskDetailsData = await taskDetailsResponse.json();
        
        const taskMessages = taskMessagesData.messages || [];
        const taskDetails = taskDetailsData.task || {};
        
        console.log(`Found ${taskMessages.length} task-specific messages`);
        
        let html = '<div class="task-expansion-inner">';
        
        if (taskMessages.length > 0) {
            // Has task-specific messages
            const sortedMessages = taskMessages.sort((a, b) => new Date(a.date) - new Date(b.date));
            html += `
                <div class="task-message-header">
                    <h4>Task Messages (${taskMessages.length} total)</h4>
                    <p>Messages specifically attached to this task</p>
                </div>
                <div class="task-messages-list">
                    ${renderTaskMessages(sortedMessages)}
                </div>
            `;
        } else {
            // No task messages - try to find relevant project messages
            console.log('No task messages, checking for relevant project messages...');
            
            const projectId = taskDetails.projectid;
            if (projectId) {
                const projectMessagesResponse = await fetch(`/api/rest/project/${projectId}/messages`);
                const projectMessagesData = await projectMessagesResponse.json();
                const projectMessages = projectMessagesData.messages || [];
                
                // Use existing function to find relevant messages
                const relevantMessages = getTaskContextMessages(projectMessages, taskDetails);
                
                if (relevantMessages.length > 0) {
                    const sortedMessages = relevantMessages.sort((a, b) => new Date(a.date) - new Date(b.date));
                    html += `
                        <div class="task-message-header">
                            <h4>Related Project Messages (${relevantMessages.length} found)</h4>
                            <p>Project messages that appear related to this task</p>
                        </div>
                        <div class="task-messages-list">
                            ${renderTaskMessages(sortedMessages)}
                        </div>
                    `;
                } else {
                    html += `
                        <div class="task-message-header">
                            <h4>No Messages Found</h4>
                            <p>This task has no specific messages and no related project messages were found.</p>
                        </div>
                    `;
                }
            } else {
                html += `
                    <div class="task-message-header">
                        <h4>No Messages Found</h4>
                        <p>This task has no associated messages.</p>
                    </div>
                `;
            }
        }
        
        html += '</div>';
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading task messages:', error);
        container.innerHTML = `
            <div class="task-expansion-inner">
                <div class="task-message-header">
                    <h4>Error Loading Messages</h4>
                    <p>Could not load messages for this task.</p>
                </div>
            </div>
        `;
    }
}

	
	// Helper function to render task messages (ADD THIS)
function renderTaskMessages(messages) {
    return messages.map(message => {
        const messageDate = new Date(message.date).toLocaleDateString();
        const messageTime = new Date(message.date).toLocaleTimeString();
        
        return `
            <div class="message-item">
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author-name message-author ${message.authortype}">
                            ${message.authorname}
                        </span>
                        <span class="message-date">${messageDate} ${messageTime}</span>
                    </div>
                    <div class="message-text">${stripHtmlTags(message.content)}</div>
                    ${message.files && message.files.length > 0 ? `
                        <div class="message-files">
                            ${message.files.map(file => `
                                <a href="${file.link}" target="_blank" class="message-file">
                                    📎 ${file.name} (${formatFileSize(file.size) || 'unknown size'})
                                </a>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');
}

function openTaskMessages(taskId, taskTitle) {
    // You can implement task message modal here if needed
    // For now, just log the task
    console.log(`Opening messages for task ${taskId}: ${taskTitle}`);
    alert(`Task messages feature - Task ${taskId}: ${taskTitle}`);
}

document.addEventListener('DOMContentLoaded', () => {
    console.log('🚀 Dashboard loaded, starting project load…');

    const managerSelect = document.getElementById('managerSelect');
    const sortSelect = document.getElementById('sortSelect');

    if (managerSelect) {
        managerSelect.addEventListener('change', () => {
            currentSort.direction = 'desc';
            loadProjects();
        });
    }

    if (sortSelect) {
        sortSelect.addEventListener('change', (e) => {
            currentSort.field = e.target.value || 'idle';
            currentSort.direction = 'desc';
            loadProjects();
        });
    }

    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    }

    if (typeof loadStatusOptions === 'function') {
        loadStatusOptions().catch(() => {/* non-fatal */});
    }

    console.log('🚀 loadProjects() triggered, about to fetch');
    if (typeof loadProjects === 'function') {
        loadProjects();
    } else {
        console.error('❌ loadProjects is not defined');
    }
});   // closes the event listener
</script>
	</body>
</html>