<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProWorkflow Team Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.4;
            font-size: 14px;
        }

        /* MAIN CONTAINER - ADJUST FOR SIDEBAR */
        .main-container {
            transition: margin-right 0.3s ease;
            margin-right: 0;
        }

        .main-container.chat-open {
            margin-right: 350px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .header p {
            font-size: 1rem;
        }

        .nav-bar {
            background: white;
            padding: 1rem 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .nav-link {
            color: #667eea;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: background-color 0.2s ease;
            font-weight: 500;
        }

        .nav-link:hover {
            background: #f1f5f9;
        }

        .nav-link.active {
            background: #667eea;
            color: white;
        }

        .controls {
            background: white;
            padding: 1.5rem 2rem;
            margin: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .control-group label {
            font-weight: 600;
            color: #555;
            font-size: 0.8rem;
        }

        select, button {
            padding: 0.6rem 0.8rem;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
            transition: all 0.3s ease;
        }

        select:focus, button:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            min-width: 120px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        /* COMMUNICATION LEGEND */
        .communication-legend {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-left: auto;
            display: flex;
            gap: 1.5rem;
            align-items: center;
            font-size: 0.8rem;
        }

        .legend-title {
            font-weight: 600;
            color: #374151;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .legend-badge {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-badge.active { background: #10b981; }
        .legend-badge.normal { background: #f59e0b; }
        .legend-badge.stale { background: #ef4444; }
        .legend-badge.none { background: #94a3b8; }

        .stats {
            display: flex;
            gap: 1rem;
            margin: 0 1.5rem 1.5rem 1.5rem;
            flex-wrap: wrap;
        }

        .stat-card {
            background: white;
            padding: 1.2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            flex: 1;
            min-width: 180px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .projects-container {
            margin: 0 1.5rem 2rem 1.5rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .projects-header {
            background: #f8fafc;
            padding: 1.2rem 1.5rem;
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .projects-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }

        .projects-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .projects-table th {
            background: #f8fafc;
            padding: 0.8rem 1rem;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #e1e8ed;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.8rem;
        }

        .projects-table th.sortable {
            cursor: pointer;
            user-select: none;
            background: #f1f5f9;
            transition: background-color 0.2s ease;
            border: 1px solid #e1e8ed;
        }

        .projects-table th.sortable:hover {
            background: #e2e8f0;
            color: #4c63d2;
        }

        .sort-indicator {
            margin-left: 8px;
            font-size: 0.9rem;
            opacity: 0.7;
            transition: opacity 0.2s ease;
            font-weight: bold;
        }

        .sort-indicator.active {
            opacity: 1;
            color: #667eea;
            font-weight: bold;
        }

        .projects-table td {
            padding: 0.8rem 1rem;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
            word-wrap: break-word;
            max-width: 200px;
        }

        .projects-table tbody tr:hover {
            background: #f8fafc;
        }

        .project-number {
            font-family: 'Monaco', 'Menlo', monospace;
            background: #f1f5f9;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #475569;
        }

        .project-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease;
            font-size: 0.85rem;
            word-wrap: break-word;
            display: block;
        }

        .project-link:hover {
            color: #4c63d2;
            text-decoration: underline;
        }

        .status-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            display: inline-block;
            min-width: 70px;
            text-align: center;
        }

        .communication-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            display: inline-block;
            min-width: 70px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .communication-badge:hover {
            transform: scale(1.05);
        }

        .communication-badge.active {
            background: #10b981;
            color: white;
        }

        .communication-badge.normal {
            background: #f59e0b;
            color: white;
        }

        .communication-badge.stale {
            background: #ef4444;
            color: white;
        }

        .communication-badge.none {
            background: #94a3b8;
            color: white;
        }

        .last-message-info {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.2rem;
        }

        .message-author {
            font-weight: 600;
        }

        .message-author.staff {
            color: #2563eb;
        }

        .message-author.client {
            color: #dc2626;
        }

        .days-badge {
            background: #f1f5f9;
            color: #64748b;
            padding: 0.25rem 0.6rem;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .days-badge.urgent {
            background: #fee2e2;
            color: #dc2626;
        }

        .days-badge.warning {
            background: #fef3c7;
            color: #d97706;
        }

        .expand-btn {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }

        .expand-btn:hover {
            background: #e2e8f0;
            border-color: #cbd5e1;
            transform: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .expand-arrow {
            width: 0;
            height: 0;
            border-left: 8px solid #667eea;
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
            transition: transform 0.3s ease;
            transform-origin: 35% 50%;
        }

        .expand-btn.expanded .expand-arrow {
            transform: rotate(90deg);
        }

        .project-expansion {
            display: none;
            background: #fafbfc;
            border-left: 4px solid #667eea;
        }

        .project-expansion.expanded {
            display: block;
        }

        .expansion-content {
            padding: 1.5rem;
        }

        /* MESSAGE TIMELINE STYLES */
        .message-timeline {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .timeline-title {
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        .load-more-messages {
            color: #667eea;
            text-decoration: none;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .load-more-messages:hover {
            text-decoration: underline;
        }

        .message-item {
            display: flex;
            gap: 0.8rem;
            padding: 0.8rem;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.85rem;
        }

        .message-item:last-child {
            border-bottom: none;
        }

        .message-item.thread-reply {
            margin-left: 2rem;
            background: #f8fafc;
            border-left: 2px solid #cbd5e1;
            border-radius: 0 8px 8px 0;
            padding-left: 1rem;
        }

        .message-item.thread-reply::before {
            content: '↳ ';
            color: #9ca3af;
            font-weight: bold;
            margin-right: 0.5rem;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .message-content {
            flex: 1;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
        }

        .message-author-name {
            font-weight: 600;
            font-size: 0.85rem;
        }

        .message-date {
            color: #64748b;
            font-size: 0.75rem;
        }

        .message-text {
            color: #475569;
            line-height: 1.4;
        }

        .message-files {
            margin-top: 0.5rem;
        }

        .message-file {
            display: inline-block;
            background: #e0e7ff;
            color: #3730a3;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            text-decoration: none;
            margin-right: 0.5rem;
            margin-top: 0.3rem;
        }

        .message-file:hover {
            background: #c7d2fe;
        }

        /* TASK TABLE STYLES */
        .tasks-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            margin-top: 1rem;
        }

        .tasks-table th {
            background: #f1f5f9;
            padding: 0.6rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e2e8f0;
            font-size: 0.75rem;
        }

        .tasks-table td {
            padding: 0.6rem;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle;
        }

        .tasks-table tbody tr:hover {
            background: #f8fafc;
        }

        .task-checkbox {
            width: 16px;
            height: 16px;
            border: 2px solid #cbd5e1;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .task-checkbox.completed {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        .task-checkbox.completed::after {
            content: '✓';
            font-size: 10px;
            font-weight: bold;
        }

        .task-title {
            font-weight: 600;
            color: #374151;
            word-wrap: break-word;
            line-height: 1.3;
        }

        .task-title.completed {
            text-decoration: line-through;
            opacity: 0.6;
        }

        /* TASK MESSAGE MODAL STYLES */
        .message-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 90%;
            max-height: 80%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-weight: 600;
            color: #374151;
            font-size: 1.1rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #9ca3af;
            min-width: auto;
            padding: 0.5rem;
        }

        .modal-close:hover {
            color: #374151;
            transform: none;
            box-shadow: none;
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        /* TASK MESSAGE BADGES */
        .task-message-badge {
            background: #3b82f6;
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .task-message-badge:hover {
            transform: scale(1.05);
        }

        .task-message-badge.active {
            background: #10b981;
        }

        .task-message-badge.normal {
            background: #f59e0b;
        }

        .task-message-badge.stale {
            background: #ef4444;
        }

        .task-message-badge.none {
            background: #94a3b8;
            cursor: default;
        }

        .task-message-badge.none:hover {
            transform: none;
        }

        /* RIGHT SIDEBAR CHAT */
        .chat-trigger {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            width: 60px;
            height: 60px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .chat-trigger:hover {
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.4);
        }

        .chat-trigger.chat-open {
            right: 370px;
        }

        .chat-sidebar {
            position: fixed;
            top: 0;
            right: -350px;
            width: 350px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.08);
            transition: right 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .chat-sidebar.open {
            right: 0;
        }

        .chat-sidebar-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chat-sidebar-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin: 0;
        }

        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.2rem;
            min-width: auto;
        }

        .chat-close:hover {
            transform: none;
            box-shadow: none;
            opacity: 0.8;
        }

        .chat-sidebar-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            padding-top: 2rem;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background: #f8fafc;
            border-radius: 12px;
            margin-bottom: 1rem;
            max-height: calc(100vh - 250px);
        }

        .chat-message {
            max-width: 80%;
            padding: 0.8rem 1rem;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .chat-message.user {
            align-self: flex-end;
            background: #667eea;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-message.agent {
            align-self: flex-start;
            background: white;
            color: #374151;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chat-input-container {
            display: flex;
            gap: 0.5rem;
        }

        .chat-input {
            flex: 1;
            padding: 0.8rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
            resize: none;
            min-height: 40px;
            max-height: 100px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .chat-send {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.8rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            min-width: auto;
            transition: background-color 0.2s ease;
        }

        .chat-send:hover {
            background: #5a67d8;
            transform: none;
            box-shadow: none;
        }

        .chat-send:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .typing-indicator {
            align-self: flex-start;
            background: white;
            color: #374151;
            padding: 0.8rem 1rem;
            border-radius: 12px;
            border-bottom-left-radius: 4px;
            font-style: italic;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
            color: #667eea;
            font-size: 1.1rem;
        }

        .loading::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #667eea;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-projects {
            text-align: center;
            padding: 3rem;
            color: #666;
            font-size: 1.1rem;
        }

        .no-messages {
            text-align: center;
            padding: 2rem;
            color: #9ca3af;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="main-container" id="mainContainer">
        <div class="header">
            <h1>ProWorkflow Team Dashboard</h1>
            <p>Track your team's projects and communication</p>
        </div>

        <div class="nav-bar">
            <a href="/" class="nav-link active">Dashboard</a>
            <a href="/assignment-queue" class="nav-link">Assignment Queue</a>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="managerSelect">Filter by Manager</label>
                <select id="managerSelect">
                    <option value="">All Team Members</option>
                </select>
            </div>

            <div class="control-group">
                <label for="sortSelect">Sort by</label>
                <select id="sortSelect">
                    <option value="idle">Most Idle First</option>
                    <option value="age">Oldest Projects</option>
                    <option value="communication">Communication Stale</option>
                    <option value="manager">Manager Name</option>
                    <option value="number">Project Number</option>
                    <option value="status">Status</option>
                    <option value="title">Project Title</option>
                </select>
            </div>

            <div class="control-group">
                <label>&nbsp;</label>
                <button onclick="loadProjects()">Refresh Data</button>
            </div>

            <!-- COMMUNICATION REFERENCE LEGEND -->
            <div class="communication-legend">
                <div class="legend-title">Communication Health:</div>
                <div class="legend-item">
                    <div class="legend-badge active"></div>
                    <span>Active (≤2 days)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-badge normal"></div>
                    <span>Normal (3-7 days)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-badge stale"></div>
                    <span>Stale (>7 days)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-badge none"></div>
                    <span>No Messages</span>
                </div>
            </div>
        </div>

        <div class="stats" id="stats"></div>

        <div class="projects-container">
            <div class="projects-header">
                <div class="projects-title" id="projectsTitle">Team Projects</div>
            </div>
            
            <div class="projects-table-container">
                <div id="projectsContent">
                    <div class="loading">Loading projects...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- CHAT TRIGGER BUTTON -->
    <button class="chat-trigger" id="chatTrigger" onclick="toggleChatSidebar()">
        💬
    </button>

    <!-- RIGHT SIDEBAR CHAT -->
    <div class="chat-sidebar" id="chatSidebar">
        <div class="chat-sidebar-header">
            <h3 class="chat-sidebar-title">Assistant</h3>
            <button class="chat-close" onclick="toggleChatSidebar()">&times;</button>
        </div>
        <div class="chat-sidebar-content">
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message agent">
                    Hi! I'm your ProWorkflow AI assistant. I can help you analyze projects, identify bottlenecks, suggest actions, and answer questions about your dashboard data. What can I help you with?
                </div>
            </div>
            <div class="chat-input-container">
                <textarea class="chat-input" id="chatInput" placeholder="Ask me about your projects..." rows="1"></textarea>
                <button class="chat-send" id="chatSend" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <!-- TASK MESSAGE MODAL -->
    <div id="taskMessageModal" class="message-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="taskModalTitle">Task Messages</div>
                <button class="modal-close" onclick="closeTaskMessageModal()">&times;</button>
            </div>
            <div class="modal-body" id="taskModalBody">
                <div class="loading">Loading messages...</div>
            </div>
        </div>
    </div>

    <script>
        let allProjects = [];
        let availableManagers = [];
        let expandedProjects = new Set();
        let currentSort = { field: 'idle', direction: 'desc' };
        let chatHistory = [];

        // THREADING HELPER FUNCTIONS
        function buildMessageThreads(messages) {
            const messageMap = new Map();
            const rootMessages = [];
            
            // Sort messages chronologically first
            const sortedMessages = messages.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Create map of all messages
            sortedMessages.forEach(message => {
                messageMap.set(message.id, {
                    ...message,
                    replies: []
                });
            });
            
            // Build thread structure using originalmessageid
            sortedMessages.forEach(message => {
                const messageObj = messageMap.get(message.id);
                
                if (message.originalmessageid && messageMap.has(message.originalmessageid)) {
                    // This is a reply - add to parent's replies
                    const parent = messageMap.get(message.originalmessageid);
                    parent.replies.push(messageObj);
                } else {
                    // This is a root message
                    rootMessages.push(messageObj);
                }
            });
            
            return rootMessages;
        }

        function renderThreadedMessages(threadedMessages) {
            return threadedMessages.map(message => {
                let messageHtml = `
                    <div class="message-item">
                        <img src="${message.authorimage}" alt="${message.authorname}" class="message-avatar" onerror="this.style.display='none'">
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-author-name message-author ${message.authortype}">${message.authorname}</span>
                                <span class="message-date">${new Date(message.date).toLocaleDateString()} ${new Date(message.date).toLocaleTimeString()}</span>
                            </div>
                            <div class="message-text">${stripHtmlTags(message.content)}</div>
                            ${message.files && message.files.length > 0 ? `
                                <div class="message-files">
                                    ${message.files.map(file => `
                                        <a href="${file.link}" target="_blank" class="message-file">
                                            📎 ${file.name} (${formatFileSize(file.size)})
                                        </a>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                // Render replies with indentation and threading indicator
                if (message.replies && message.replies.length > 0) {
                    messageHtml += message.replies.map(reply => `
                        <div class="message-item thread-reply">
                            <img src="${reply.authorimage}" alt="${reply.authorname}" class="message-avatar" onerror="this.style.display='none'">
                            <div class="message-content">
                                <div class="message-header">
                                    <span class="message-author-name message-author ${reply.authortype}">${reply.authorname}</span>
                                    <span class="message-date">${new Date(reply.date).toLocaleDateString()} ${new Date(reply.date).toLocaleTimeString()}</span>
                                </div>
                                <div class="message-text">${stripHtmlTags(reply.content)}</div>
                                ${reply.files && reply.files.length > 0 ? `
                                    <div class="message-files">
                                        ${reply.files.map(file => `
                                            <a href="${file.link}" target="_blank" class="message-file">
                                                📎 ${file.name} (${formatFileSize(file.size)})
                                            </a>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `).join('');
                }
                
                return messageHtml;
            }).join('');
        }

        function stripHtmlTags(html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            return tempDiv.textContent || tempDiv.innerText || '';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function loadProjects() {
            const manager = document.getElementById('managerSelect').value;
            
            document.getElementById('projectsContent').innerHTML = '<div class="loading">Loading projects...</div>';
            
            try {
                let url = '/api/rest/projects-table';
                const params = new URLSearchParams();
                
                if (manager) params.append('manager', manager);
                if (currentSort.field) params.append('sort', currentSort.field);
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                console.log('Loading with sort:', currentSort.field, currentSort.direction);
                
                const response = await fetch(url);
                const data = await response.json();
                
                allProjects = data.projects || [];
                availableManagers = data.availableManagers || [];
                
                console.log('✅ Projects loaded:', allProjects.length);
                
                updateManagerDropdown();
                updateStats(data);
                renderProjects(allProjects);
                
            } catch (error) {
                console.error('❌ Error loading projects:', error);
                document.getElementById('projectsContent').innerHTML = 
                    '<div class="no-projects">Error loading projects. Please try again.</div>';
            }
        }

        function sortByHeader(field) {
            console.log('Sorting by header:', field);
            
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }
            
            const dropdown = document.getElementById('sortSelect');
            dropdown.value = field;
            
            loadProjects();
        }

        function getProjectCommunication(project) {
            if (!project.lastMessageDate) {
                return {
                    status: 'none',
                    text: 'No Messages',
                    class: 'none',
                    extraInfo: ''
                };
            }
            
            const days = project.daysSinceLastMessage;
            let status, text, className;
            
            if (days <= 2) {
                status = 'active';
                text = 'Active';
                className = 'active';
            } else if (days <= 7) {
                status = 'normal';
                text = 'Normal';
                className = 'normal';
            } else {
                status = 'stale';
                text = 'Stale';
                className = 'stale';
            }
            
            const authorClass = project.lastMessageType === 'staff' ? 'staff' : 'client';
            const extraInfo = `<span class="message-author ${authorClass}">${project.lastMessageAuthor}</span> • ${days}d ago`;
            
            return {
                status: status,
                text: text,
                class: className,
                extraInfo: extraInfo
            };
        }

        function renderProjects(projects) {
            console.log('🎨 Rendering projects:', projects.length);
            
            if (!projects || projects.length === 0) {
                document.getElementById('projectsContent').innerHTML = 
                    '<div class="no-projects">No projects found with current filters.</div>';
                return;
            }

            const container = document.getElementById('projectsContent');
            container.innerHTML = '';
            
            const table = document.createElement('table');
            table.className = 'projects-table';
            
            // Create header with clickable sorting
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            const headerConfig = [
                { text: '', field: null },
                { text: 'Project #', field: 'number' },
                { text: 'Title', field: 'title' },
                { text: 'Manager', field: 'manager' },
                { text: 'Custom Status', field: 'status' },
                { text: 'Start', field: null },
                { text: 'Due Date', field: 'dueDate' },
                { text: 'Communication', field: 'communication' },
                { text: 'Days Idle', field: 'idle' }
            ];

            headerConfig.forEach(config => {
                const th = document.createElement('th');
                th.textContent = config.text;
                
                if (config.field) {
                    th.className = 'sortable';
                    th.onclick = () => sortByHeader(config.field);
                    
                    const indicator = document.createElement('span');
                    indicator.className = 'sort-indicator';
                    
                    if (currentSort.field === config.field) {
                        indicator.className += ' active';
                        indicator.textContent = currentSort.direction === 'asc' ? ' ↑' : ' ↓';
                    } else {
                        indicator.textContent = ' ↕';
                    }
                    
                    th.appendChild(indicator);
                }
                
                headerRow.appendChild(th);
            });

            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create body
            const tbody = document.createElement('tbody');
            
            projects.forEach((project, index) => {
                // Main project row
                const row = document.createElement('tr');
                
                // Add RUSH highlighting
                const isRush = project.customStatus && project.customStatus.toLowerCase().includes('rush');
                if (isRush) {
                    row.style.backgroundColor = '#fef3c7';
                }
                
                // Expand button cell
                const expandCell = document.createElement('td');
                const expandBtn = document.createElement('button');
                expandBtn.className = 'expand-btn';
                expandBtn.onclick = () => toggleProject(project.projectId, expandBtn);
                
                const arrow = document.createElement('div');
                arrow.className = 'expand-arrow';
                expandBtn.appendChild(arrow);
                expandCell.appendChild(expandBtn);
                row.appendChild(expandCell);
                
                // Get communication info for this project
                const communicationInfo = getProjectCommunication(project);
                
                // Project data cells
                const cells = [
                    { content: project.number, class: 'project-number' },
                    { 
                        content: project.title, 
                        link: project.projectUrl, 
                        class: 'project-link'
                    },
                    { content: project.owner },
                    { content: project.customStatus, style: `background: ${project.statusColor}; color: white;`, class: 'status-badge' },
                    { content: project.startDate || 'No start date' },
                    { content: project.dueDate || '-' },
                    { 
                        content: communicationInfo.text, 
                        class: `communication-badge ${communicationInfo.class}`,
                        extraContent: communicationInfo.extraInfo
                    },
                    { content: project.daysIdle > 0 ? project.daysIdle + ' days' : 'Active', class: getDaysClass(project.daysIdle) }
                ];

                cells.forEach(cellData => {
                    const td = document.createElement('td');
                    
                    if (cellData.link) {
                        const link = document.createElement('a');
                        link.href = cellData.link;
                        link.target = '_blank';
                        link.className = cellData.class || '';
                        link.textContent = cellData.content;
                        td.appendChild(link);
                    } else {
                        const span = document.createElement('span');
                        if (cellData.class) span.className = cellData.class;
                        if (cellData.style) span.setAttribute('style', cellData.style);
                        span.textContent = cellData.content;
                        td.appendChild(span);
                        
                        if (cellData.extraContent) {
                            const extraDiv = document.createElement('div');
                            extraDiv.className = 'last-message-info';
                            extraDiv.innerHTML = cellData.extraContent;
                            td.appendChild(extraDiv);
                        }
                    }
                    
                    row.appendChild(td);
                });

                tbody.appendChild(row);
                
                // Project expansion row (hidden by default)
                const expansionRow = document.createElement('tr');
                const expansionCell = document.createElement('td');
                expansionCell.colSpan = 9;
                
                const expansionSection = document.createElement('div');
                expansionSection.className = 'project-expansion';
                expansionSection.id = `expansion-${project.projectId}`;
                
                expansionCell.appendChild(expansionSection);
                expansionRow.appendChild(expansionCell);
                tbody.appendChild(expansionRow);
            });
            
            table.appendChild(tbody);
            container.appendChild(table);
            
            console.log('✅ Projects rendered successfully');
        }

        async function toggleProject(projectId, button) {
            const expansionSection = document.getElementById(`expansion-${projectId}`);
            
            if (expandedProjects.has(projectId)) {
                // Collapse
                expansionSection.classList.remove('expanded');
                button.classList.remove('expanded');
                expandedProjects.delete(projectId);
            } else {
                // Expand and load content
                button.classList.add('expanded');
                expansionSection.classList.add('expanded');
                expandedProjects.add(projectId);
                
                expansionSection.innerHTML = '<div class="expansion-content"><div class="loading">Loading project details...</div></div>';
                await loadProjectExpansion(projectId);
            }
        }

        async function loadProjectExpansion(projectId) {
            try {
                console.log(`🔍 Loading expansion for project ${projectId}`);
                
                const expansionSection = document.getElementById(`expansion-${projectId}`);
                const project = allProjects.find(p => p.projectId == projectId);
                
                // Load project tasks and messages
                const tasksResponse = await fetch(`/api/rest/project/${projectId}/tasks?limit=50`);
                const tasksData = await tasksResponse.json();
                const tasks = tasksData.tasks || [];
                
                console.log(`📋 Loaded ${tasks.length} tasks for project ${projectId}`);
                
                // Build project messages timeline
                let projectMessagesHtml = '';
                if (project && project.messages && project.messages.length > 0) {
                    const recentMessages = project.messages
                        .sort((a, b) => new Date(b.date) - new Date(a.date))
                        .slice(0, 3);
                    
                    const hasMoreMessages = project.messages.length > 3;
                    
                    projectMessagesHtml = `
                        <div class="message-timeline">
                            <div class="timeline-header">
                                <div class="timeline-title">Recent Project Messages (${project.messageCount} total)</div>
                                ${hasMoreMessages ? `<a href="${project.projectUrl}" target="_blank" class="load-more-messages">View All in ProWorkflow</a>` : ''}
                            </div>
                            ${recentMessages.map(message => `
                                <div class="message-item">
                                    <img src="${message.authorimage}" alt="${message.authorname}" class="message-avatar" onerror="this.style.display='none'">
                                    <div class="message-content">
                                        <div class="message-header">
                                            <span class="message-author-name message-author ${message.authortype}">${message.authorname}</span>
                                            <span class="message-date">${new Date(message.date).toLocaleDateString()} ${new Date(message.date).toLocaleTimeString()}</span>
                                        </div>
                                        <div class="message-text">${stripHtmlTags(message.content).substring(0, 200)}${message.content.length > 200 ? '...' : ''}</div>
                                        ${message.files && message.files.length > 0 ? `
                                            <div class="message-files">
                                                ${message.files.map(file => `
                                                    <a href="${file.link}" target="_blank" class="message-file">
                                                        📎 ${file.name} (${formatFileSize(file.size)})
                                                    </a>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // Build tasks table
                let tasksHtml = '';
                if (tasks.length > 0) {
                    tasksHtml = `
                        <table class="tasks-table">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"></th>
                                    <th style="width: 80px;">Task #</th>
                                    <th style="width: 300px;">Task Title</th>
                                    <th style="width: 100px;">Priority</th>
                                    <th style="width: 150px;">Assigned To</th>
                                    <th style="width: 100px;">Due Date</th>
                                    <th style="width: 100px;">Messages</th>
                                    <th style="width: 80px;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tasks.map(task => {
                                    let priorityText = 'Medium';
                                    let priorityStyle = 'background: #9ca3af; color: white;';
                                    
                                    switch(task.priority) {
                                        case 1:
                                            priorityText = 'Very High';
                                            priorityStyle = 'background: #dc2626; color: white;';
                                            break;
                                        case 2:
                                            priorityText = 'High';
                                            priorityStyle = 'background: #f97316; color: white;';
                                            break;
                                        case 3:
                                            priorityText = 'Medium';
                                            priorityStyle = 'background: #9ca3af; color: white;';
                                            break;
                                        case 4:
                                            priorityText = 'Low';
                                            priorityStyle = 'background: #3b82f6; color: white;';
                                            break;
                                        case 5:
                                            priorityText = 'Very Low';
                                            priorityStyle = 'background: #1e3a8a; color: white;';
                                            break;
                                    }

                                    let dueDateDisplay = task.dueDate || '-';
                                    let dueDateStyle = 'color: #666;';
                                    if (task.dueDateStatus === 'overdue') {
                                        dueDateStyle = 'background: #fee2e2; color: #dc2626; padding: 0.2rem 0.4rem; border-radius: 4px;';
                                    } else if (task.dueDateStatus === 'due-soon') {
                                        dueDateStyle = 'background: #fef3c7; color: #d97706; padding: 0.2rem 0.4rem; border-radius: 4px;';
                                    }

                                    // Task message badge
                                    let messageBadge = '';
                                    if (task.taskMessageCount > 0) {
                                        const health = task.taskCommunicationHealth || 'normal';
                                        messageBadge = `
                                            <span class="task-message-badge ${health}" onclick="openTaskMessages(${task.id}, '${task.title.replace(/'/g, "\\'")}', 'task')" title="Task-specific messages">
                                                💬 ${task.taskMessageCount}
                                            </span>
                                        `;
                                    } else {
                                        messageBadge = '<span class="task-message-badge none" title="No task-specific messages">💬 -</span>';
                                    }

                                    return `
                                        <tr>
                                            <td>
                                                <div class="task-checkbox ${task.completed ? 'completed' : ''}"></div>
                                            </td>
                                            <td style="font-family: monospace; font-size: 0.8rem; color: #666;">
                                                ${task.taskNumber}
                                            </td>
                                            <td>
                                                <div class="task-title ${task.completed ? 'completed' : ''}">${task.title}</div>
                                            </td>
                                            <td style="text-align: center;">
                                                <span style="padding: 0.2rem 0.5rem; border-radius: 8px; font-size: 0.7rem; font-weight: 600; ${priorityStyle}">${priorityText}</span>
                                            </td>
                                            <td style="font-size: 0.8rem; color: #666;">
                                                ${task.assignedTo}
                                            </td>
                                            <td style="font-size: 0.8rem;">
                                                <span style="${dueDateStyle}">${dueDateDisplay}</span>
                                            </td>
                                            <td style="text-align: center;">
                                                ${messageBadge}
                                            </td>
                                            <td style="font-size: 0.8rem; color: #666;">
                                                ${task.status}
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        <div style="margin-top: 1rem; color: #666; font-size: 0.8rem;">
                            Showing ${tasks.length} of ${tasksData.totalTasks} tasks
                        </div>
                    `;
                } else {
                    tasksHtml = '<div class="no-messages">No tasks found</div>';
                }
                
                expansionSection.innerHTML = `
                    <div class="expansion-content">
                        ${projectMessagesHtml}
                        ${tasksHtml}
                    </div>
                `;
                
                console.log(`✅ Expansion loaded for project ${projectId}`);
                
            } catch (error) {
                console.error(`❌ Error loading expansion for project ${projectId}:`, error);
                const expansionSection = document.getElementById(`expansion-${projectId}`);
                expansionSection.innerHTML = '<div class="expansion-content"><div style="color: #dc2626; padding: 1rem;">Error loading project details</div></div>';
            }
        }

        // TASK MESSAGE FUNCTIONS
        async function openTaskMessages(taskId, taskTitle, type) {
            const modal = document.getElementById('taskMessageModal');
            const modalTitle = document.getElementById('taskModalTitle');
            const modalBody = document.getElementById('taskModalBody');
            
            modalTitle.textContent = `💬 ${taskTitle}`;
            modalBody.innerHTML = '<div class="loading">Loading task messages...</div>';
            modal.style.display = 'flex';
            
            try {
                console.log(`🔍 Loading threaded messages for task ${taskId}`);
                
                const response = await fetch(`/api/rest/task/${taskId}/messages`);
                const data = await response.json();
                const messages = data.messages || [];
                
                if (messages.length === 0) {
                    modalBody.innerHTML = '<div class="no-messages">No task-specific messages found.<br><small>All communication for this task may be in the project-level messages.</small></div>';
                    return;
                }
                
                // Build threaded conversation structure
                const threadedMessages = buildMessageThreads(messages);
                
                modalBody.innerHTML = `
                    <div class="message-timeline">
                        <div class="timeline-header">
                            <div class="timeline-title">Task-Specific Messages (${messages.length} total) - Threaded</div>
                        </div>
                        ${renderThreadedMessages(threadedMessages)}
                    </div>
                `;
                
            } catch (error) {
                console.error(`❌ Error loading messages for task ${taskId}:`, error);
                modalBody.innerHTML = '<div style="color: #dc2626; padding: 1rem;">Error loading task messages</div>';
            }
        }

        function closeTaskMessageModal() {
            document.getElementById('taskMessageModal').style.display = 'none';
        }

        // CHAT SIDEBAR FUNCTIONALITY
        function toggleChatSidebar() {
            const sidebar = document.getElementById('chatSidebar');
            const trigger = document.getElementById('chatTrigger');
            const mainContainer = document.getElementById('mainContainer');
            
            if (sidebar.classList.contains('open')) {
                // Close sidebar
                sidebar.classList.remove('open');
                trigger.classList.remove('chat-open');
                mainContainer.classList.remove('chat-open');
            } else {
                // Open sidebar
                sidebar.classList.add('open');
                trigger.classList.add('chat-open');
                mainContainer.classList.add('chat-open');
                document.getElementById('chatInput').focus();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const messages = document.getElementById('chatMessages');
            const sendButton = document.getElementById('chatSend');
            
            const userMessage = input.value.trim();
            if (!userMessage) return;
            
            // Add user message to chat
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'chat-message user';
            userMessageDiv.textContent = userMessage;
            messages.appendChild(userMessageDiv);
            
            // Clear input and disable send button
            input.value = '';
            sendButton.disabled = true;
            
            // Add typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.textContent = 'AI is thinking...';
            messages.appendChild(typingDiv);
            
            // Scroll to bottom
            messages.scrollTop = messages.scrollHeight;
            
// REPLACE THIS SECTION IN YOUR sendMessage() function:
try {
    // Send to chat API
    const response = await fetch('/api/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: userMessage,
            context: {
                projects: allProjects.length,
                currentPage: 'dashboard'
            }
        })
    });
    
    const data = await response.json();
    
    // Remove typing indicator
    messages.removeChild(typingDiv);
    
    // Add AI response
    const aiMessageDiv = document.createElement('div');
    aiMessageDiv.className = 'chat-message agent';
    aiMessageDiv.textContent = data.response;
    messages.appendChild(aiMessageDiv);
    
    // Store in chat history
    chatHistory.push({ user: userMessage, ai: data.response, timestamp: new Date() });
                
            } catch (error) {
                // Remove typing indicator and show error
                messages.removeChild(typingDiv);
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'chat-message agent';
                errorDiv.textContent = 'Sorry, I encountered an error. Please try again.';
                messages.appendChild(errorDiv);
                
                console.error('Chat API Error:', error);
            }
            
            // Re-enable send button and scroll to bottom
            sendButton.disabled = false;
            messages.scrollTop = messages.scrollHeight;
        }

        function generateIntelligentResponse(message) {
            const msg = message.toLowerCase();
            
            // Context-aware responses based on dashboard state
            if (msg.includes('stale') || msg.includes('communication')) {
                return "I can see your communication health data. Projects with red badges (>7 days) need immediate attention. Would you like me to identify which clients to follow up with?";
            }
            
            if (msg.includes('overdue') || msg.includes('deadline')) {
                return "I can help you identify overdue projects and tasks. Check the red deadline badges in your project list. Would you like me to prioritize them by urgency?";
            }
            
            if (msg.includes('rush') || msg.includes('urgent')) {
                return "RUSH projects are highlighted in yellow. I can help you track their progress and ensure they're moving through the workflow quickly.";
            }
            
            if (msg.includes('assignment') || msg.includes('assign')) {
                return "For assignment management, check your Assignment Queue at /assignment-queue. I can help you match projects to the right team members based on skills and workload.";
            }
            
            if (msg.includes('task') || msg.includes('message')) {
                return "Your dashboard shows task assignments and communication health. Click the blue expand arrows to see detailed task lists for each project, and click the 💬 badges to see threaded task messages.";
            }
            
            if (msg.includes('dashboard') || msg.includes('help')) {
                return "Your dashboard shows: 🟢 Active projects (≤2 days), 🟡 Normal (3-7 days), 🔴 Stale (>7 days). Use filters to sort by communication health, due dates, or manager. What specific area would you like help with?";
            }
            
            if (msg.includes('hello') || msg.includes('hi')) {
                return "Hi! I'm your ProWorkflow AI assistant. I can help you analyze project health, identify bottlenecks, suggest follow-ups, and navigate your dashboard. What would you like to know?";
            }
            
            // Default intelligent response
            return `I understand you're asking about "${message}". I can help you analyze your ProWorkflow data, identify communication gaps, track project health, and suggest actions. Your dashboard shows ${allProjects.length} projects with real-time communication monitoring. What specific insights would you like?`;
        }

        // Handle Enter key in chat input
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chatInput');
            
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Auto-resize textarea
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });

            // Close modal when clicking outside
            const modal = document.getElementById('taskMessageModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeTaskMessageModal();
                    }
                });
            }
        });

        function updateManagerDropdown() {
            const select = document.getElementById('managerSelect');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">All Team Members</option>';
            
            availableManagers.forEach(manager => {
                const option = document.createElement('option');
                option.value = manager.id;
                option.textContent = manager.name;
                select.appendChild(option);
            });
            
            if (currentValue) {
                select.value = currentValue;
            }
        }

        function updateStats(data) {
            const projects = data.projects || [];
            const totalProjects = projects.length;
            
            const activeCommProjects = projects.filter(p => p.communicationHealth === 'active').length;
            const staleCommProjects = projects.filter(p => p.communicationHealth === 'stale').length;
            const needingAttention = projects.filter(p => p.lastMessageType === 'client').length;
            const waitingForClient = projects.filter(p => p.lastMessageType === 'staff').length;

            document.getElementById('stats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${totalProjects}</div>
                    <div class="stat-label">Total Projects</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #10b981;">${activeCommProjects}</div>
                    <div class="stat-label">Active Communication</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #ef4444;">${staleCommProjects}</div>
                    <div class="stat-label">Stale Communication</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #dc2626;">${needingAttention}</div>
                    <div class="stat-label">Need Attention</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #f59e0b;">${waitingForClient}</div>
                    <div class="stat-label">Waiting for Client</div>
                </div>
            `;
        }

        function getDaysClass(daysIdle) {
            if (daysIdle > 30) return 'days-badge urgent';
            if (daysIdle > 14) return 'days-badge warning';
            return 'days-badge';
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Dashboard loaded, starting project load...');
            
            document.getElementById('managerSelect').addEventListener('change', loadProjects);
            document.getElementById('sortSelect').addEventListener('change', (e) => {
                currentSort.field = e.target.value;
                currentSort.direction = 'desc';
                loadProjects();
            });
            
            // Load projects after everything is set up
            loadProjects();
        });
    </script>
</body>
</html>